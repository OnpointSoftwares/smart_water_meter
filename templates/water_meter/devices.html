{% extends 'base.html' %}
{% load static %}

{% block title %}Devices - Smart Water Meter{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-cpu text-primary"></i> Device Management
                    </h1>
                    <p class="text-muted">Monitor and manage your water meter devices</p>
                </div>
                {% if user.is_staff %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                    <i class="bi bi-plus-circle"></i> Add Device
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Device Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h2 class="stat-number text-success" id="online-devices">-</h2>
                            <p class="stat-label">Online Devices</p>
                        </div>
                        <div class="stat-icon text-success">
                            <i class="bi bi-wifi"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card border-start border-danger border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h2 class="stat-number text-danger" id="offline-devices">-</h2>
                            <p class="stat-label">Offline Devices</p>
                        </div>
                        <div class="stat-icon text-danger">
                            <i class="bi bi-wifi-off"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h2 class="stat-number text-warning" id="warning-devices">-</h2>
                            <p class="stat-label">Warning Status</p>
                        </div>
                        <div class="stat-icon text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stat-card border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h2 class="stat-number text-info" id="total-devices">-</h2>
                            <p class="stat-label">Total Devices</p>
                        </div>
                        <div class="stat-icon text-info">
                            <i class="bi bi-cpu"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Devices List -->
    <div class="row">
        <div class="col-12">
            <div class="card hover-card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list text-primary"></i> Your Devices
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshDevices()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="statusFilter" id="filterAll" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="filterAll">All</label>
                            
                            <input type="radio" class="btn-check" name="statusFilter" id="filterOnline">
                            <label class="btn btn-outline-success btn-sm" for="filterOnline">Online</label>
                            
                            <input type="radio" class="btn-check" name="statusFilter" id="filterOffline">
                            <label class="btn btn-outline-danger btn-sm" for="filterOffline">Offline</label>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Last Seen</th>
                                    <th>Today's Usage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="devices-tbody">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="loading-spinner">
                                            <div class="spinner-border spinner-border-custom text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Device Modal -->
{% if user.is_staff %}
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Add New Device
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addDeviceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="deviceId" class="form-label">Device ID</label>
                        <input type="text" class="form-control" id="deviceId" required>
                        <div class="form-text">Unique identifier for the device (e.g., DEVICE_001)</div>
                    </div>
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="deviceName" required>
                        <div class="form-text">Friendly name for the device</div>
                    </div>
                    <div class="mb-3">
                        <label for="deviceLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="deviceLocation" required>
                        <div class="form-text">Physical location of the device</div>
                    </div>
                    <div class="mb-3">
                        <label for="pulseRate" class="form-label">Pulse Rate</label>
                        <input type="number" class="form-control" id="pulseRate" value="450" step="0.1">
                        <div class="form-text">Pulses per liter (default: 450 for YF-S201)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Device</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Device Details Modal -->
<div class="modal fade" id="deviceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Device Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="device-details-content">
                <!-- Device details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadDeviceReport()">
                    <i class="bi bi-download"></i> Download Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let devicesData = [];

document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    
    // Filter event listeners
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', filterDevices);
    });
    
    // Add device form handler
    {% if user.is_staff %}
    if (document.getElementById('addDeviceForm')) {
        document.getElementById('addDeviceForm').addEventListener('submit', handleAddDevice);
    }
    {% endif %}
});

function loadDevices() {
    fetch('/api/devices/')
        .then(response => response.json())
        .then(data => {
            devicesData = data.results || data;
            updateDeviceStats();
            displayDevices(devicesData);
        })
        .catch(error => {
            console.error('Error loading devices:', error);
            showError('Failed to load devices');
        });
}

function updateDeviceStats() {
    const now = new Date();
    let online = 0, offline = 0, warning = 0;
    
    devicesData.forEach(device => {
        if (!device.last_seen) {
            offline++;
        } else {
            const lastSeen = new Date(device.last_seen);
            const diffMinutes = (now - lastSeen) / (1000 * 60);
            
            if (diffMinutes < 5) {
                online++;
            } else if (diffMinutes < 30) {
                warning++;
            } else {
                offline++;
            }
        }
    });
    
    document.getElementById('online-devices').textContent = online;
    document.getElementById('offline-devices').textContent = offline;
    document.getElementById('warning-devices').textContent = warning;
    document.getElementById('total-devices').textContent = devicesData.length;
}

function displayDevices(devices) {
    const tbody = document.getElementById('devices-tbody');
    
    if (!devices || devices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                    <i class="bi bi-cpu display-6"></i>
                    <p class="mt-2">No devices found</p>
                    {% if user.is_staff %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                        <i class="bi bi-plus-circle"></i> Add Your First Device
                    </button>
                    {% endif %}
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = devices.map(device => {
        const statusInfo = getDeviceStatus(device.last_seen);
        const todayUsage = Math.random() * 100; // Simulate today's usage
        
        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-cpu fs-4 text-primary"></i>
                        </div>
                        <div>
                            <strong>${device.name}</strong>
                            <br>
                            <small class="text-muted">${device.device_id}</small>
                        </div>
                    </div>
                </td>
                <td>${device.location}</td>
                <td>
                    <span class="badge bg-${statusInfo.color}">
                        <i class="bi bi-${statusInfo.icon}"></i> ${statusInfo.text}
                    </span>
                </td>
                <td>
                    <span class="text-muted">${formatLastSeen(device.last_seen)}</span>
                </td>
                <td>
                    <strong>${todayUsage.toFixed(1)} L</strong>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDevice('${device.device_id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        {% if user.is_staff %}
                        <button class="btn btn-sm btn-outline-secondary" onclick="editDevice('${device.device_id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice('${device.device_id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function getDeviceStatus(lastSeen) {
    if (!lastSeen) {
        return { color: 'secondary', icon: 'question-circle', text: 'Unknown' };
    }
    
    const now = new Date();
    const lastSeenDate = new Date(lastSeen);
    const diffMinutes = (now - lastSeenDate) / (1000 * 60);
    
    if (diffMinutes < 5) {
        return { color: 'success', icon: 'wifi', text: 'Online' };
    } else if (diffMinutes < 30) {
        return { color: 'warning', icon: 'exclamation-triangle', text: 'Warning' };
    } else {
        return { color: 'danger', icon: 'wifi-off', text: 'Offline' };
    }
}

function formatLastSeen(lastSeen) {
    if (!lastSeen) return 'Never';
    
    const now = new Date();
    const lastSeenDate = new Date(lastSeen);
    const diffMinutes = (now - lastSeenDate) / (1000 * 60);
    
    if (diffMinutes < 1) return 'Just now';
    if (diffMinutes < 60) return `${Math.round(diffMinutes)} min ago`;
    
    const diffHours = diffMinutes / 60;
    if (diffHours < 24) return `${Math.round(diffHours)} hours ago`;
    
    const diffDays = diffHours / 24;
    return `${Math.round(diffDays)} days ago`;
}

function filterDevices() {
    const filter = document.querySelector('input[name="statusFilter"]:checked').id;
    let filteredDevices = devicesData;
    
    if (filter === 'filterOnline') {
        filteredDevices = devicesData.filter(device => {
            if (!device.last_seen) return false;
            const diffMinutes = (new Date() - new Date(device.last_seen)) / (1000 * 60);
            return diffMinutes < 5;
        });
    } else if (filter === 'filterOffline') {
        filteredDevices = devicesData.filter(device => {
            if (!device.last_seen) return true;
            const diffMinutes = (new Date() - new Date(device.last_seen)) / (1000 * 60);
            return diffMinutes >= 30;
        });
    }
    
    displayDevices(filteredDevices);
}

function refreshDevices() {
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    icon.classList.add('fa-spin');
    button.disabled = true;
    
    loadDevices();
    
    setTimeout(() => {
        icon.classList.remove('fa-spin');
        button.disabled = false;
    }, 1000);
}

function viewDevice(deviceId) {
    const device = devicesData.find(d => d.device_id === deviceId);
    if (!device) return;
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Device Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Device ID:</strong></td><td>${device.device_id}</td></tr>
                    <tr><td><strong>Name:</strong></td><td>${device.name}</td></tr>
                    <tr><td><strong>Location:</strong></td><td>${device.location}</td></tr>
                    <tr><td><strong>Owner:</strong></td><td>${device.owner.username}</td></tr>
                    <tr><td><strong>Pulse Rate:</strong></td><td>${device.pulse_rate} pulses/L</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Status Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getDeviceStatus(device.last_seen).color}">${getDeviceStatus(device.last_seen).text}</span></td></tr>
                    <tr><td><strong>Last Seen:</strong></td><td>${formatLastSeen(device.last_seen)}</td></tr>
                    <tr><td><strong>Installed:</strong></td><td>${new Date(device.installation_date).toLocaleDateString()}</td></tr>
                    <tr><td><strong>Active:</strong></td><td>${device.is_active ? 'Yes' : 'No'}</td></tr>
                </table>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-12">
                <h6>Recent Activity</h6>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    Device activity and usage charts would be displayed here in a full implementation.
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('device-details-content').innerHTML = content;
    new bootstrap.Modal(document.getElementById('deviceDetailsModal')).show();
}

{% if user.is_staff %}
function handleAddDevice(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const deviceData = {
        device_id: formData.get('device_id'),
        name: formData.get('name'),
        location: formData.get('location')
    };
    
    fetch('/api/devices/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(deviceData)
    })
    .then(response => response.json())
    .then(data => {
        devicesData.push(data);
        updateDeviceStats();
        displayDevices(devicesData);
        
        bootstrap.Modal.getInstance(document.getElementById('addDeviceModal')).hide();
        event.target.reset();
        
        showNotification('Device added successfully!', 'success');
    })
    .catch(error => {
        console.error('Error adding device:', error);
        showNotification('Error adding device', 'danger');
    });
}

function editDevice(deviceId) {
    showInfo(`Edit functionality for device ${deviceId} would be implemented here.`);
}

function deleteDevice(deviceId) {
    if (confirm(`Are you sure you want to delete device ${deviceId}?`)) {
        showSuccess(`Device ${deviceId} deleted successfully!`);
        loadDevices();
    }
}
{% endif %}

function downloadDeviceReport() {
    showInfo('Device report download would be implemented here.');
}

function showSuccess(message) {
    showNotification(message, 'success');
}

function showError(message) {
    showNotification(message, 'danger');
}

function showInfo(message) {
    showNotification(message, 'info');
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 90px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
